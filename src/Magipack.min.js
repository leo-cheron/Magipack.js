/**
 * 
 * Copyright (c) 2014 Keita Kuroki
 * Released under MIT license:
 * http://www.opensource.org/licenses/mit-license.php
 *  
 * For more information:
 * https://github.com/keitakun/Magipack.js
 * code@hellokeita.in
 * 
 **/
 window.Magipack=function(){function GetIEByteArray_ByteStr(a){for(var b={},c=0;256>c;c++)for(var d=0;256>d;d++)b[String.fromCharCode(c+256*d)]=String.fromCharCode(c)+String.fromCharCode(d);var e=IEBinaryToArray_ByteStr(a),f=IEBinaryToArray_ByteStr_Last(a);return e.replace(/[\s\S]/g,function(a){return b[a]})+f}function b64encodeString(a){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";c=c.split("");var d=a.length,e=0;b=0;for(var i,j,k,l,m,n,o,p="";d>e;)i=255&a.charCodeAt(e+0),j=255&a.charCodeAt(e+1),k=255&a.charCodeAt(e+2),l=63&i>>2,m=63&(i<<4|j>>4),n=63&(j<<2|k>>6),o=63&k,p+=c[l]+c[m]+c[n]+c[o],e+=3;return e=d%3,d=p.length,1==e?p=p.substr(0,d-2)+"==":2==e&&(p=p.substr(0,d-1)+"="),p}function req(){return window.XMLHttpRequest?new XMLHttpRequest:window.ActiveXObject?new ActiveXObject("MSXML2.XMLHTTP.3.0"):void 0}function Magipack(a,b){this.progress=0,a&&this.init(a,b)}window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,Magipack.isIE=Boolean(document.all);var hasBlob=!1;try{hasBlob=Boolean(Blob)}catch(e){hasBlob=!1}if(Magipack.hasBlob=hasBlob,Magipack.version="0.1",!Magipack.hasBlob){var s=document.createElement("script");s.type="text/vbscript",s.text='Function IEBinaryToArray_ByteStr(Binary)\n	IEBinaryToArray_ByteStr = CStr(Binary)\nEnd Function\nFunction IEBinaryToArray_ByteStr_Last(Binary)\n	Dim lastIndex\n	lastIndex = LenB(Binary)\n	if lastIndex mod 2 Then\n		IEBinaryToArray_ByteStr_Last = Chr( AscB( MidB( Binary, lastIndex, 1 ) ) )\n	Else\n		IEBinaryToArray_ByteStr_Last = ""\n	End If\nEnd Function',document.childNodes[document.childNodes.length-1].appendChild(s)}return Magipack.prototype._onProgress=function(a){p=a.position/a.totalSize,isNaN(p)&&(p=0),this._configComplete?p=.9*p+.1:p*=.1,this.progress=p,this.onProgress&&this.onProgress(p,1)},Magipack.prototype._loadFile=function(a,b,c){var d=req();if(!c){c="arraybuffer";try{Blob.prototype.slice&&(c="blob")}catch(e){}}d.open("GET",a,!0),d.responseType=c;var f=b,g=this;d.onprogress=function(a){g._onProgress(a)},d.onreadystatechange=function(){4==this.readyState&&(f&&f.call(g,this),this.onreadystatechange=null)},d.send(null)},Magipack.prototype._configLoaded=function(e){this._configComplete=!0,this.config=eval("("+e.responseText+")"),this._loadFile(this.pack,this._packLoaded)},Magipack.prototype._packLoaded=function(a){Magipack.hasBlob?this.init(a.response,this.config):this.init(a.responseBody,this.config),this.onLoadComplete&&this.onLoadComplete(this)},Magipack.prototype._findFile=function(a){var b;for(b=this.config.length;b-->0;)if(this.config[b][0]==a)return this.config[b];for(;b-->0;)if(a.indexOf(this.config[b][0])>=0)return this.config[b]},Magipack.prototype._getRange=function(a,b,c){if(Magipack.hasBlob){var d;if(this.blob.slice)return d=this.blob.slice(a,b,c),window.URL.createObjectURL(d);if(this.blob.webkitSlice)return d=this.blob.webkitSlice(a,b,c),window.URL.createObjectURL(d);if(this.blob.mozSlice)return d=this.blob.mozSlice(a,b,c),window.URL.createObjectURL(d)}else if(Magipack.isIE)return"data:"+c+";base64,"+b64encodeString(this.ieBlob.substr(a,b-a))},Magipack.prototype.init=function(a,b){this.config=b,null!=a&&(Magipack.hasBlob?this.blob=new Blob([a]):this.ieBlob=GetIEByteArray_ByteStr(a))},Magipack.prototype.load=function(a,b){this.pack=a,b?this._loadFile(b,this._configLoaded,"text"):this._loadFile(a,this._packLoaded)},Magipack.prototype.getURI=function(){if(0==arguments.length)throw new Error("Not enough arguments.");if(isNaN(arguments[0])&&!this.config)throw new Error("No config file loaded.");var a;if(!isNaN(arguments[0])&&!isNaN(arguments[1]))return a=arguments[2],a||(a="text/plain"),this._getRange(arguments[0],arguments[1],a);var b=this._findFile(arguments[0]);if(!b)throw new Error("File not found in pack.");return a=b[3],a||(a="text/plain"),this._getRange(b[1],b[2],a)},Magipack.init=function(a,b){if(this.inited)throw new Error("Magipack static instance already initialized.");this._instance=new Magipack(a,b),a&&this._instance.init(a,b),this.inited=!0},Magipack.load=function(a,b){this.inited||this.init(),this._instance.onLoadComplete=this.onLoadComplete,this._instance.load(a,b)},Magipack.getURI=function(){return this._instance.getURI.apply(this._instance,arguments)},Magipack}();